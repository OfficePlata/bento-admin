<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€åº—ä¸»ç”¨ã€‘ã‚‰ãã‚‰ãå¼å½“ç®¡ç†</title>
  <style>
    :root {
      --primary-color: #1db446;
      --error-color: #ff4d4f;
      --bg-color: #f0f2f5;
      --accent-color: #007aff;
    }
    body { font-family: -apple-system, "Helvetica Neue", Arial, sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 80px; color: #333; }
    header { background: var(--primary-color); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    
    .container { padding: 12px; max-width: 500px; margin: 0 auto; }
    
    .card { background: white; margin-bottom: 16px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; position: relative; }
    
    .image-container { position: relative; width: 100%; height: 180px; background: #eee; overflow: hidden; }
    .card-image { width: 100%; height: 100%; object-fit: cover; }
    .image-edit-overlay { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }

    .card-body { padding: 16px; }
    
    .flex-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    
    .title-area { flex: 1; padding-right: 10px; }
    .title { font-weight: bold; font-size: 18px; line-height: 1.3; }
    .option-text { font-size: 13px; color: #666; margin-top: 4px; }
    
    .status-badge { font-size: 12px; padding: 4px 12px; border-radius: 20px; font-weight: bold; white-space: nowrap; }
    .status-on { background: #e6ffed; color: #1db446; border: 1px solid #b7eb8f; }
    .status-off { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; }
    
    .price-section { display: flex; align-items: center; gap: 8px; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
    .price-label { font-size: 14px; font-weight: bold; color: #888; }
    .price-input { flex: 1; font-size: 22px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; text-align: right; font-weight: bold; color: var(--primary-color); width: 100%; }
    
    .action-group { display: flex; gap: 10px; }
    .btn { border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; transition: opacity 0.2s; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn:active { opacity: 0.7; }
    .btn:disabled { background: #ccc !important; cursor: not-allowed; }
    .btn-save { background: var(--primary-color); color: white; flex: 2; }
    .btn-toggle { background: #f0f0f0; color: #555; flex: 1; }
    .btn-toggle.to-off { background: #fff1f0; color: #ff4d4f; }
    .btn-toggle.to-on { background: #e6ffed; color: #1db446; }

    .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary-color); color: white; border-radius: 30px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; z-index: 200; cursor: pointer; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 20px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 20px; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; font-size: 18px; position: sticky; top: 0; background: white; z-index: 10; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 6px; color: #555; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
    textarea.form-control { height: 80px; resize: none; }

    #loading { text-align: center; padding: 100px 20px; color: #999; }
    .loading-spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .error-box { background: #fff1f0; color: #ff4d4f; padding: 20px; border-radius: 12px; border: 1px solid #ffa39e; margin: 20px; text-align: center; }

    .preview-area { width: 100%; height: 150px; background: #f8f8f8; border: 2px dashed #ddd; border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin-top: 8px; cursor: pointer; }
    .preview-area img { width: 100%; height: 100%; object-fit: cover; }
    .preview-area.has-img::after { content: 'ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã—ã¦å¤‰æ›´'; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 11px; padding: 4px; text-align: center; }
  </style>
</head>
<body>
  <header>ãŠå¼å½“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</header>
  
  <div class="container" id="app">
    <div id="loading">
      <div class="loading-spinner"></div>
      <div>æƒ…å ±ã‚’å–å¾—ä¸­...</div>
    </div>
  </div>

  <button class="fab" onclick="openModal()" title="æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ">ï¼‹</button>

  <div id="add-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>
      <div class="modal-body">
        <div class="form-group">
          <label>å•†å“å</label>
          <input type="text" id="new-name" class="form-control" placeholder="ä¾‹: å”æšã’å¼å½“">
        </div>
        <div class="form-group">
          <label>ä¾¡æ ¼ (å††)</label>
          <input type="number" id="new-price" class="form-control" placeholder="700">
        </div>
        <div class="form-group">
          <label>èª¬æ˜æ–‡</label>
          <textarea id="new-description" class="form-control" placeholder="å•†å“ã®ã“ã ã‚ã‚Šãªã©"></textarea>
        </div>
        <div class="form-group">
          <label>ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†™çœŸ</label>
          <div class="preview-area" id="new-preview-box" onclick="document.getElementById('new-file').click()">
            <div id="new-preview-placeholder">ğŸ“¸ å†™çœŸã‚’é¸æŠ</div>
            <img id="new-preview-img" style="display:none">
          </div>
          <input type="file" id="new-file" style="display:none" accept="image/*" onchange="previewImage(this, 'new-preview-img', 'new-preview-placeholder', 'new-preview-box')">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-toggle" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-save" id="btn-add-submit" style="flex:2" onclick="addNewMenu()">ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <input type="file" id="swap-file" style="display:none" accept="image/*">

  <script>
    // â˜…é‡è¦: ã‚ãªãŸã®GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è¨˜å…¥ã—ã¦ãã ã•ã„
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxiBqWGuGsZIAvkEFOgWJkodL9lYngLYioboQf0BSj-PIrNb1GQBiWpG8QG9OHX47Q0/exec';
    let currentMenuData = [];

    async function loadMenu() {
      const appContainer = document.getElementById('app');
      try {
        const response = await fetch(`${BACKEND_URL}?action=getAdminMenu`);
        if (!response.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ');
        const data = await response.json();
        if (data.error) throw new Error(data.message);
        currentMenuData = data;
        render(data);
      } catch (e) {
        console.error('Fetch error:', e);
        appContainer.innerHTML = `
          <div class="error-box">
            <p><strong>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</strong></p>
            <p style="font-size:12px; color:#666;">åŸå› : ${e.message}</p>
            <button onclick="loadMenu()" style="margin-top:15px; padding:10px 20px; border-radius:8px; border:1px solid #ddd; background:white;">å†èª­ã¿è¾¼ã¿</button>
          </div>
        `;
      }
    }

    function render(items) {
      const container = document.getElementById('app');
      if (!items || items.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:50px; color:#888;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="card" id="card-${item.sku}">
          <div class="image-container">
            <img src="${item.imageUrl || 'https://placehold.jp/24/cccccc/ffffff/300x200.png?text=No+Image'}" class="card-image" id="img-${item.sku}" onerror="this.src='https://placehold.jp/24/cccccc/ffffff/300x200.png?text=Image+Error'">
            <div class="image-edit-overlay" onclick="triggerSwapImage('${item.sku}')">
              <span>ğŸ“· ç”»åƒã‚’å¤‰æ›´</span>
            </div>
          </div>
          <div class="card-body">
            <div class="flex-header">
              <div class="title-area">
                <div class="title">${item.name}</div>
                <div class="option-text">${item.optionName || 'é€šå¸¸'}</div>
              </div>
              <span class="status-badge ${item.isOnSale ? 'status-on' : 'status-off'}">
                ${item.isOnSale ? 'è²©å£²ä¸­' : 'å£²ã‚Šåˆ‡ã‚Œä¸­'}
              </span>
            </div>
            
            <div class="price-section">
              <span class="price-label">è²©å£²ä¾¡æ ¼</span>
              <span style="font-size:18px; font-weight:bold;">Â¥</span>
              <input type="number" id="p-${item.sku}" class="price-input" value="${item.price}" pattern="\\d*">
            </div>
            
            <div class="action-group">
              <button class="btn btn-save" onclick="update('${item.sku}', ${item.isOnSale})" id="save-${item.sku}">ä¿å­˜ã™ã‚‹</button>
              <button class="btn btn-toggle ${item.isOnSale ? 'to-off' : 'to-on'}" onclick="update('${item.sku}', ${!item.isOnSale})" id="toggle-${item.sku}">
                ${item.isOnSale ? 'å£²ã‚Šåˆ‡ã‚Œã«ã™ã‚‹' : 'è²©å£²ã‚’å†é–‹'}
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function update(sku, isOnSale, base64Image = null) {
      const priceInput = document.getElementById('p-' + sku);
      const price = priceInput.value;
      
      if (!price || price < 0) {
        alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!base64Image) {
        const confirmMsg = isOnSale ? 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' : 'ã“ã®å•†å“ã‚’å£²ã‚Šåˆ‡ã‚Œï¼ˆéè¡¨ç¤ºï¼‰ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ';
        if (!confirm(confirmMsg)) return;
      }

      setBusy(true, sku);

      try {
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'updateMenu',
            sku: sku,
            price: parseInt(price, 10),
            isOnSale: isOnSale,
            imageData: base64Image
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert(base64Image ? 'ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
          await loadMenu();
        } else {
          alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (e) {
        console.error('Update error:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } finally {
        setBusy(false, sku);
      }
    }

    function triggerSwapImage(sku) {
      const fileInput = document.getElementById('swap-file');
      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!confirm('ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…¥ã‚Œæ›¿ãˆã¾ã™ã‹ï¼Ÿ')) return;
        
        const base64 = await toBase64(file);
        const item = currentMenuData.find(i => i.sku === sku);
        update(sku, item.isOnSale, base64);
      };
      fileInput.click();
    }

    function openModal() { document.getElementById('add-modal').classList.add('active'); }
    function closeModal() { 
      document.getElementById('add-modal').classList.remove('active');
      document.getElementById('new-name').value = '';
      document.getElementById('new-price').value = '';
      document.getElementById('new-description').value = '';
      document.getElementById('new-file').value = '';
      document.getElementById('new-preview-img').style.display = 'none';
      document.getElementById('new-preview-placeholder').style.display = 'block';
      document.getElementById('new-preview-box').classList.remove('has-img');
    }

    async function addNewMenu() {
      const name = document.getElementById('new-name').value;
      const price = document.getElementById('new-price').value;
      const desc = document.getElementById('new-description').value;
      const fileInput = document.getElementById('new-file');
      
      if (!name || !price) {
        alert('å•†å“åã¨ä¾¡æ ¼ã¯å¿…é ˆã§ã™ã€‚');
        return;
      }

      const submitBtn = document.getElementById('btn-add-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'å‡¦ç†ä¸­...';

      try {
        let imageData = null;
        if (fileInput.files[0]) {
          imageData = await toBase64(fileInput.files[0]);
        }

        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'addMenu',
            name: name,
            price: parseInt(price, 10),
            description: desc,
            imageData: imageData
          })
        });

        const result = await response.json();
        if (result.success) {
          alert('æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
          closeModal();
          await loadMenu();
        } else {
          alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
      } catch (e) {
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
      }
    }

    function setBusy(isBusy, sku) {
      const saveBtn = document.getElementById('save-' + sku);
      const toggleBtn = document.getElementById('toggle-' + sku);
      if (saveBtn) saveBtn.disabled = isBusy;
      if (toggleBtn) toggleBtn.disabled = isBusy;
      if (isBusy && saveBtn) saveBtn.textContent = 'å‡¦ç†ä¸­...';
      else if (saveBtn) saveBtn.textContent = 'ä¿å­˜ã™ã‚‹';
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    function previewImage(input, imgId, placeholderId, boxId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.getElementById(imgId);
          img.src = e.target.result;
          img.style.display = 'block';
          document.getElementById(placeholderId).style.display = 'none';
          document.getElementById(boxId).classList.add('has-img');
        };
        reader.readAsDataURL(file);
      }
    }

    window.onload = loadMenu;
  </script>
</body>
</html>
